<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Neuratec</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        /* Mantive seu estilo original fielmente */
        body { background:#f5f6fa; }

        .circle-img {
            width:180px;
            height:180px;
            border-radius:50%;
            overflow:hidden;
            border:6px solid #2b6cb0;
            box-shadow:0 6px 20px rgba(43,108,176,0.18);
        }

        .circle-img img { width:100%; height:100%; object-fit:cover; }

        .chat-header-img {
            width:48px; height:48px;
            border-radius:50%;
            border:3px solid #fff;
            object-fit:cover;
        }

        .bot-msg {
            background:#F1F1F1;
            padding:10px 14px;
            border-radius:10px;
            max-width:75%;
            white-space:pre-wrap;
            font-family: monospace;
            font-size: 13px;
        }

        .user-msg {
            background:#DCF8C6;
            padding:10px 14px;
            border-radius:10px;
            max-width:75%;
            margin-left:auto;
            word-break: break-word;
        }

        #chatBox {
            display:none;
            margin-top:30px;
        }

        /* NOVO: Caixa de mensagens fixa com rolagem interna */
        #messages {
            height:420px !important;
            overflow-y:auto;
            background: linear-gradient(180deg, #ffffff, #fbfdff);
            padding: 12px;
            border-radius: 0 0 6px 6px;
        }

        .typing {
            font-style: italic;
            color: #6c757d;
            margin-bottom: 8px;
        }

        /* Área extra de controle */
        #controls {
            margin-top: 18px;
        }

        .control-card {
            background: #ffffff;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }

        .metric-badge { font-weight:600; font-size:13px; display:inline-block; margin-right:8px; }

        /* small responsive tweaks */
        @media (max-width: 576px) {
            .circle-img { width:120px; height:120px; }
            .bot-msg, .user-msg { font-size: 14px; }
        }
    </style>
</head>
<body>

<div class="container py-4">

    <!-- =============================== -->
    <!--        INTERFACE PRINCIPAL      -->
    <!-- =============================== -->

    <div class="text-center">
        <div class="circle-img mx-auto mb-3">
            <img src="NeuratecLogotipo.jpg" alt="Foto do perfil">
        </div>

        <h2>Neuratec</h2>
        <p class="text-muted">9.654 seguidores</p>

        <button class="btn btn-primary btn-lg mt-3" onclick="toggleChat()">
            Chat
        </button>
    </div>

    <!-- =============================== -->
    <!--   ÁREA DO CHAT (MESMA PÁGINA)   -->
    <!-- =============================== -->

    <div id="chatBox">
        <div class="card shadow-sm mt-4">
            <div class="card-header d-flex align-items-center gap-3">
                <img src="NeuratecLogotipo.jpg" class="chat-header-img" alt="logo">
                <div>
                    <strong>Neuratec</strong><br>
                    <span class="text-muted" style="font-size:13px;">Robô virtual — modo Sandbox (simulação avançada)</span>
                </div>
            </div>

            <div id="messages" class="card-body" aria-live="polite"></div>

            <div class="card-footer">
                <div class="input-group">
                    <input id="msgInput" class="form-control" placeholder="Digite sua mensagem..." required
                           onkeydown="if(event.key==='Enter'){ sendMsg(); }" aria-label="Mensagem">
                    <button class="btn btn-primary" onclick="sendMsg()">Enviar</button>
                </div>
            </div>
        </div>

        <!-- NOVA ÁREA: Controles e ações rápidas -->
        <div id="controls" class="mt-3">
            <div class="control-card">
                <h5>Controles rápidos</h5>
                <p class="text-muted">Ações rápidas para testar o simulador virtual.</p>
                <div class="d-flex gap-2 flex-wrap mb-2">
                    <button class="btn btn-outline-primary" onclick="sendQuick('Simular cell_alpha 5s')">Simular cell_alpha 5s</button>
                    <button class="btn btn-outline-primary" onclick="sendQuick('Simular cell_alpha 15s')">Simular 15s</button>
                    <button class="btn btn-outline-secondary" onclick="sendQuick('Status')">Status</button>
                    <button class="btn btn-outline-secondary" onclick="sendQuick('Listar dispositivos')">Listar dispositivos</button>
                    <button class="btn btn-outline-success" onclick="sendQuick('Energia cell_alpha 10s')">Energia 10s</button>
                </div>

                <hr>

                <h6>Comando manual</h6>
                <div class="input-group mb-2">
                    <input id="cmdInput" class="form-control" placeholder="ex: Simular cell_alpha 8s">
                    <button class="btn btn-dark" onclick="sendCmd()">Executar</button>
                </div>

                <div class="mt-2">
                    <strong>Comandos suportados (exemplos):</strong>
                    <ul class="mb-0">
                        <li><code>Simular cell_alpha 10s</code></li>
                        <li><code>Energia cell_alpha 10s</code></li>
                        <li><code>Status</code></li>
                        <li><code>Listar dispositivos</code></li>
                        <li><code>/cpu</code>, <code>/memoria</code>, <code>/rede</code>, <code>/ping</code>, <code>/limpar</code></li>
                        <li>Qualquer outra mensagem → responde <code>"Hello."</code></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- =============================== -->
<!--           JAVASCRIPT            -->
<!-- =============================== -->

<script>
/*
  Neuratec — Simulação Avançada (autônoma)
  - Mantém interface original
  - Sem WebSocket / sem backend
  - Simulação local de dispositivos, energia, logs e métricas
  - Persistência em localStorage
*/

/* ------------------------------
   Utilitários
   ------------------------------ */
function nowISO() {
    return new Date().toISOString();
}
function rand(min, max, digits=2) {
    return +(Math.random() * (max - min) + min).toFixed(digits);
}

/* ------------------------------
   Simulador (JS) — funcionalidade avançada
   ------------------------------ */
class DeviceSimulator {
    constructor() {
        // Dispositivos virtuais iniciais
        this.devices = {
            "cell_alpha": {
                id: "cell_alpha",
                type: "electronic_cell_virtual",
                specs: {
                    nominal_voltage_mv: 3000,
                    capacity_mah: 50,
                    architecture: "micro-lattice v1"
                },
                last_sim: null
            },
            "cell_beta": {
                id: "cell_beta",
                type: "electronic_cell_virtual",
                specs: {
                    nominal_voltage_mv: 2500,
                    capacity_mah: 30,
                    architecture: "micro-lattice v2"
                },
                last_sim: null
            }
        };
    }

    listDevices() {
        return Object.keys(this.devices);
    }

    statusSummary() {
        const lines = ["Neuratec Simulator — status:"];
        for (const id in this.devices) {
            const d = this.devices[id];
            const last = d.last_sim ? `${d.last_sim.status} @ ${d.last_sim.timestamp}` : "nenhuma";
            lines.push(`${id}: type=${d.type}, last_sim=${last}`);
        }
        return lines.join("\n");
    }

    // Interpreta descrições como "Simular cell_alpha 5s" ou "Energia cell_alpha 10s"
    parseDuration(description) {
        const m = description.match(/(\d+)\s*s/);
        if (m) return parseInt(m[1], 10);
        return null;
    }

    // Run a "fabrication / test" simulation
    async runSimulation(description) {
        // name
        let name = "quick_sim";
        for (const key of Object.keys(this.devices)) {
            if (description.toLowerCase().includes(key.toLowerCase())) {
                name = key;
                break;
            }
        }

        const duration_s = this.parseDuration(description) || 5;
        // Simulated processing time (non-blocking)
        const steps = Math.max(3, Math.min(12, Math.ceil(duration_s / 1)));
        // generate deterministic-ish seed from timestamp
        const seed = Date.now() % 100000;
        const metrics = {};
        const logs = [];
        logs.push(`[${nowISO()}] Iniciando simulação '${name}' — duração nominal: ${duration_s}s`);

        // stepwise simulation with pseudo-random metrics
        for (let i = 0; i < steps; i++) {
            logs.push(`[${nowISO()}] etapa ${i+1}/${steps} — processando micro-estruturas...`);
            // small async sleep to emulate typing/progress
            await new Promise(r => setTimeout(r, Math.min(300, duration_s*40)));
        }

        // final metrics
        metrics.peak_current_mA = rand(40, 160);
        metrics.avg_current_mA = rand(20, metrics.peak_current_mA - 5);
        metrics.energy_consumed_mJ = +(metrics.avg_current_mA * duration_s * rand(8, 12)).toFixed(2);
        metrics.temperature_c = rand(24, 46);
        metrics.structural_integrity = rand(80, 99, 1) + "%";
        metrics.generated_by = "Neuratec-Sim-v1";

        logs.push(`[${nowISO()}] simulação concluída — status: COMPLETED`);
        logs.push(`[${nowISO()}] metrics: ${JSON.stringify(metrics)}`);

        const result = {
            name,
            duration_s,
            status: "COMPLETED",
            timestamp: nowISO(),
            metrics,
            logs
        };

        // store last_sim
        if (this.devices[name]) this.devices[name].last_sim = {
            status: result.status,
            timestamp: result.timestamp,
            metrics: result.metrics
        };

        return result;
    }

    // Energy profile generation (time series)
    generateEnergyProfile(description) {
        const duration = this.parseDuration(description) || 10;
        const points = Math.max(5, Math.min(60, duration));
        const profile = [];
        for (let t = 0; t <= duration; t += Math.ceil(duration / points)) {
            const current = +(20 + 40*Math.abs(Math.sin(t/Math.max(1,duration))) + rand(-5,5)).toFixed(2);
            profile.push({ t: t, current_mA: current });
        }
        return {
            for: description,
            generated_at: nowISO(),
            duration_s: duration,
            points: profile
        };
    }

    // Quick system diagnostics
    diagnostics() {
        // some fake health metrics
        return {
            timestamp: nowISO(),
            cpu_load_pct: rand(1, 20),
            memory_pct: rand(10, 50),
            devices_managed: Object.keys(this.devices).length,
            uptime_s: Math.floor(performance.now() / 1000)
        };
    }

    // Simulated "list devices" detail
    deviceDetail(id) {
        const d = this.devices[id];
        if (!d) return null;
        return {
            id: d.id,
            type: d.type,
            specs: d.specs,
            last_sim: d.last_sim
        };
    }
}


/* ------------------------------
   Chat orchestration (no backend)
   ------------------------------ */

const simulator = new DeviceSimulator();

/* Persistence */
function saveMessages() {
    const messages = document.getElementById("messages").innerHTML;
    localStorage.setItem("neuratec_chat", messages);
}
function loadMessages() {
    const saved = localStorage.getItem("neuratec_chat");
    if (saved) {
        document.getElementById("messages").innerHTML = saved;
        const box = document.getElementById("messages");
        box.scrollTop = box.scrollHeight;
    }
}

/* Append message to chat */
function appendMessage(sender, text, opts={}) {
    const box = document.getElementById('messages');
    const div = document.createElement('div');

    if (sender === "user") {
        div.className = "user-msg mb-2";
        div.textContent = text;
    } else {
        div.className = "d-flex align-items-start mb-2";
        // bot message can be HTML (for tables/JSON)
        const img = "<img src='NeuratecLogotipo.jpg' style='width:32px;height:32px;border-radius:50%;margin-right:8px;'>";
        const content = typeof text === 'string' ? escapeHtml(text).replace(/\n/g,'<br>') : text;
        div.innerHTML = img + "<div class='bot-msg'>" + content + "</div>";
    }

    box.appendChild(div);
    box.scrollTop = box.scrollHeight;

    saveMessages();

    if (opts.focus) box.lastElementChild.scrollIntoView({behavior:'smooth', block:'end'});
}

/* simple escaping to avoid accidental injection */
function escapeHtml(s) {
    if (typeof s !== 'string') return s;
    return s
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
}

/* Typing indicator management */
let typingTimer = null;
function showTyping(text="Neuratec está processando...") {
    removeTyping();
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.id = "typing-indicator";
    div.className = "typing";
    div.textContent = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}
function removeTyping() {
    const t = document.getElementById('typing-indicator');
    if (t) t.remove();
}

/* Command parser and handler (advanced) */
async function handleUserText(raw) {
    const text = (raw || "").trim();
    if (!text) return;

    // Show user's message
    appendMessage("user", text);

    // Recognize built-in slash commands
    const lower = text.toLowerCase();

    // /limpar -> clear chat visually
    if (lower === "/limpar" || lower === "limpar") {
        document.getElementById('messages').innerHTML = "";
        localStorage.removeItem("neuratec_chat");
        appendMessage("bot", "Chat limpo.", {focus:true});
        return;
    }

    // /ping
    if (lower === "/ping" || lower === "ping") {
        showTyping("Pingando subsistemas...");
        await delay(400 + Math.random()*300);
        removeTyping();
        appendMessage("bot", "pong!");
        return;
    }

    // /cpu
    if (lower === "/cpu") {
        showTyping("Verificando CPU...");
        await delay(400 + Math.random()*600);
        removeTyping();
        const diag = simulator.diagnostics();
        appendMessage("bot", `CPU: ${diag.cpu_load_pct}% (simulado)`);
        return;
    }

    // /memoria
    if (lower === "/memoria" || lower === "/memória") {
        showTyping("Analisando memória...");
        await delay(350 + Math.random()*500);
        removeTyping();
        const diag = simulator.diagnostics();
        appendMessage("bot", `Memória: ${diag.memory_pct}% usada (simulado)`);
        return;
    }

    // /rede
    if (lower === "/rede" || lower === "rede") {
        showTyping("Testando enlace de rede...");
        await delay(300 + Math.random()*600);
        removeTyping();
        appendMessage("bot", "Rede: link ativo, latência sim. ~"+rand(5,40,0)+"ms");
        return;
    }

    // Status
    if (lower === "status" || lower.includes("status")) {
        showTyping("Coletando status do sistema...");
        await delay(500 + Math.random()*600);
        removeTyping();
        appendMessage("bot", simulator.statusSummary());
        return;
    }

    // Listar dispositivos
    if (lower.startsWith("listar") || lower.includes("listar dispositivos") || lower.includes("list devices")) {
        showTyping("Recuperando dispositivos registrados...");
        await delay(300 + Math.random()*500);
        removeTyping();
        const list = simulator.listDevices();
        appendMessage("bot", "Dispositivos virtuais:\n- " + list.join("\n- "));
        return;
    }

    // Energia profile
    if (lower.startsWith("energia") || lower.startsWith("energia ") || lower.includes("energia ")) {
        // e.g. Energia cell_alpha 10s
        showTyping("Gerando perfil energético...");
        await delay(400 + Math.random()*600);
        const profile = simulator.generateEnergyProfile(text);
        removeTyping();
        // display as table-like text
        let out = `Perfil de energia — duração ${profile.duration_s}s (simulado)\n`;
        out += profile.points.map(p => `t=${p.t}s -> corrente=${p.current_mA} mA`).join("\n");
        appendMessage("bot", out);
        return;
    }

    // Simular (fabrication/test)
    if (lower.startsWith("simular") || lower.startsWith("simula") || lower.includes("simular") || lower.includes("simula")) {
        // e.g. Simular cell_alpha 5s
        showTyping("Orquestrando simulação avançada...");
        // we will run the simulation and stream logs into the chat
        const result = await streamSimulation(text);
        // final result appended inside streamSimulation
        return;
    }

    // Energia keyword fallback for "Energia cell_alpha 10s" without writing 'energia' at start
    if (/energia\s+\w+/i.test(lower)) {
        showTyping("Gerando perfil energético...");
        await delay(400 + Math.random()*600);
        const profile = simulator.generateEnergyProfile(text);
        removeTyping();
        let out = `Perfil de energia — duração ${profile.duration_s}s (simulado)\n`;
        out += profile.points.map(p => `t=${p.t}s -> corrente=${p.current_mA} mA`).join("\n");
        appendMessage("bot", out);
        return;
    }

    // If contains device names and 'simular' word absent, but user likely meant simulate
    if (Object.keys(simulator.devices).some(d => lower.includes(d))) {
        showTyping("Interpretação heurística: usuário mencionou dispositivo. Interpretando como simulação...");
        await delay(300 + Math.random()*500);
        const result = await streamSimulation("Simular " + text + " 5s");
        return;
    }

    // If none matched -> default fallback "Hello."
    showTyping("Gerando resposta padronizada...");
    await delay(250 + Math.random()*300);
    removeTyping();
    appendMessage("bot", "Hello.");
}

/* helper: delay */
function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

/* streamSimulation: emits incremental logs into chat, then final result */
async function streamSimulation(description) {
    // initial message
    appendMessage("bot", `Iniciando simulação: "${description}"\nAguarde...`);
    // small wait to show initial typing
    showTyping("Neuratec: preparando ambiente virtual...");
    await delay(500 + Math.random()*400);
    removeTyping();

    // run actual simulation (which itself performs async waits)
    const result = await simulator.runSimulation(description);

    // stream logs
    for (const log of result.logs) {
        // small delay between logs to simulate streaming
        showTyping("Neuratec: executando");
        await delay(200 + Math.random()*300);
        removeTyping();
        appendMessage("bot", log);
    }

    // show metrics in a compact block (JSON-like)
    const metricsPretty = JSON.stringify(result.metrics, null, 2);
    appendMessage("bot", "Resultado final (métricas):\n" + metricsPretty);

    // also present a small summary card (HTML inside bot-msg)
    const summaryHtml = `
        <div><strong>Resumo</strong></div>
        <div class="mt-2">
            <span class="metric-badge">Nome:</span> ${escapeHtml(result.name)}<br>
            <span class="metric-badge">Duração (s):</span> ${result.duration_s}<br>
            <span class="metric-badge">Status:</span> ${result.status}<br>
            <span class="metric-badge">Timestamp:</span> ${result.timestamp}
        </div>
    `;
    // inject as HTML (appendMessage escapes by default, so insert manually)
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = "d-flex align-items-start mb-2";
    div.innerHTML = "<img src='NeuratecLogotipo.jpg' style='width:32px;height:32px;border-radius:50%;margin-right:8px;'>" +
                    "<div class='bot-msg'>" + summaryHtml + "</div>";
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    saveMessages();
    return result;
}

/* Quick controls (buttons) that call the same handler */
function sendQuick(cmd) {
    document.getElementById('msgInput').value = cmd;
    sendMsg();
}

/* Manual command in controls */
function sendCmd() {
    const cmd = document.getElementById('cmdInput').value.trim();
    if (!cmd) return;
    sendQuick(cmd);
    document.getElementById('cmdInput').value = "";
}

/* Main send function bound to UI */
function sendMsg() {
    const input = document.getElementById("msgInput");
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    handleUserText(text);
}

/* Toggle chat visibility */
function toggleChat() {
    const box = document.getElementById("chatBox");
    if (box.style.display === "none" || box.style.display === "") {
        box.style.display = "block";
        window.scrollTo(0, document.body.scrollHeight);
    } else {
        box.style.display = "none";
    }
}

/* Load persisted messages and set initial greeting */
function init() {
    loadMessages();
    // If no messages yet, inject a friendly starter
    const box = document.getElementById('messages');
    if (!box.innerHTML.trim()) {
        appendMessage("bot", "Hello. Eu sou o Neuratec — modo virtual. Posso simular células eletrônicas, estimar perfis energéticos e fornecer históricos. Use os botões abaixo ou escreva um comando.");
    }
}

/* Initialize */
init();

/* Expose some helpers for debugging in console */
window.NeuratecSim = { simulator, streamSimulation, handleUserText };

</script>

</body>
</html>
