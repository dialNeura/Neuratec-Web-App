# neuratec_app_corrected.py — versão ajustada para evitar erros em sandbox
# Servidor Flask só inicia quando a variável de ambiente RUN_FLASK_SERVER=1 estiver ativa.

from flask import Flask, render_template_string, request, redirect, url_for, session
from PIL import Image
import os, shutil

app = Flask(__name__)
app.secret_key = "neuratec_secret_key"

# Diretórios garantidos
os.makedirs("static", exist_ok=True)
PROFILE_PATH = "static/profile.png"
SOURCE_IMAGE = "NeuratecLogotipo.jpg"

# Coloca a imagem real como perfil
try:
    if os.path.exists(SOURCE_IMAGE):
        shutil.copy(SOURCE_IMAGE, PROFILE_PATH)
    else:
        img = Image.new("RGB", (800, 800), (30, 144, 255))
        img.save(PROFILE_PATH)
except:
    if not os.path.exists(PROFILE_PATH):
        with open(PROFILE_PATH, "wb") as f:
            f.write(b"")

# Templates embutidos
BASE_TEMPLATE = """
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuratec</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background:#f5f6fa; }
        .circle-img { width:180px; height:180px; border-radius:50%; overflow:hidden; border:6px solid #2b6cb0; box-shadow:0 6px 20px rgba(43,108,176,0.18); }
        .circle-img img { width:100%; height:100%; object-fit:cover; }
        .chat-header-img { width:48px; height:48px; border-radius:50%; border:3px solid #fff; object-fit:cover; }
        .bot-msg { background:#F1F1F1; padding:10px 14px; border-radius:10px; max-width:75%; }
        .user-msg { background:#DCF8C6; padding:10px 14px; border-radius:10px; max-width:75%; margin-left:auto; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">{% block content %}{% endblock %}</div>
</body>
</html>
"""

INDEX_PAGE = """
{% extends "base.html" %}
{% block content %}
<div class="text-center">
    <div class="circle-img mx-auto mb-3"><img src="{{ url_for('static', filename='profile.png') }}"></div>
    <h2>Neuratec</h2>
    <p class="text-muted">9.654 seguidores</p>
    <a href="{{ url_for('chat') }}" class="btn btn-primary btn-lg mt-3">Chat</a>
</div>
{% endblock %}
"""

CHAT_PAGE = """
{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm">
    <div class="card-header d-flex align-items-center gap-3">
        <img src="{{ url_for('static', filename='profile.png') }}" class="chat-header-img">
        <div><strong>Neuratec</strong><br><span class="text-muted" style="font-size:13px;">Responde apenas \"Hello.\"</span></div>
    </div>

    <div id="messages" class="card-body" style="min-height:420px;">
        {% for sender, text in messages %}
            {% if sender == 'user' %}
                <div class="user-msg mb-2">{{ text }}</div>
            {% else %}
                <div class="bot-msg mb-2">{{ text }}</div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="card-footer">
        <div class="input-group">
            <input id="msgInput" class="form-control" placeholder="Digite sua mensagem..." required>
            <button class="btn btn-primary" onclick="sendMsg()">Enviar</button>
        </div>
    </div>
</div>

<script>
function appendMessage(sender, text) {
    const box = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = sender === 'user' ? 'user-msg mb-2' : 'bot-msg mb-2';
    div.textContent = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function sendMsg() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text) return;

    appendMessage('user', text);
    input.value = '';

    fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ msg: text })
    })
    .then(r => r.json())
    .then(data => {
        appendMessage('bot', data.reply);
    });
}
</script>
{% endblock %}
"""

@app.route("/")
def index():
    return render_template_string(INDEX_PAGE, **{"base.html": BASE_TEMPLATE})

@app.route("/chat", methods=["GET", "POST"])
def chat():
    if request.method == "POST":
        data = request.get_json()
        msg = data.get("msg", "").strip()
        return {"reply": "Hello."}

    return render_template_string(CHAT_PAGE, messages=session.get("messages", []), **{"base.html": BASE_TEMPLATE})(CHAT_PAGE, messages=session.get("messages", []), **{"base.html": BASE_TEMPLATE})

# Para Gunicorn
application = app

# Só inicia app.run() se explicitamente permitido
if __name__ == "__main__" and os.getenv("RUN_FLASK_SERVER") == "1":
    app.run(host="0.0.0.0", port=5000, debug=False, use_reloader=False)

